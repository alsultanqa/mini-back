<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Mini Bank AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f4f5fb;
      --bg-elevated: #ffffff;
      --border-subtle: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-strong: #1d4ed8;
      --danger: #dc2626;
      --muted: #6b7280;
      --text-main: #111827;
      --text-soft: #4b5563;
      --radius-lg: 16px;
      --radius-full: 999px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.14);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0ecff 0, #f4f5fb 38%, #eef2ff 100%);
      color: var(--text-main);
    }

    body.rtl {
      direction: rtl;
    }

    body.ltr {
      direction: ltr;
    }

    .app-shell {
      display: flex;
      height: 100vh;
      max-height: 100vh;
      padding: 12px;
      gap: 12px;
    }

    @media (max-width: 900px) {
      .app-shell {
        flex-direction: column;
      }
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      max-width: 100%;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      padding: 14px 14px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (max-width: 900px) {
      .sidebar {
        flex-direction: row;
        width: 100%;
        overflow-x: auto;
        align-items: flex-start;
      }
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .logo-mark {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .logo-badge {
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #93c5fd, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #eff6ff;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.12), 0 10px 25px rgba(37, 99, 235, 0.5);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      font-size: 12px;
      line-height: 1.2;
    }

    .logo-text-main {
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 11px;
    }

    .logo-text-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      border-radius: var(--radius-full);
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 3px 8px;
      font-size: 11px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(248, 250, 252, 0.9);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .new-chat-btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      padding: 10px 12px;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 14px 40px rgba(37, 99, 235, 0.5);
    }

    .new-chat-btn span.icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.2);
      font-size: 13px;
    }

    .session-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
      max-height: calc(100vh - 180px);
    }

    @media (max-width: 900px) {
      .session-list {
        flex-direction: row;
        max-height: none;
        overflow-x: auto;
      }
    }

    .session-item {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 7px 10px;
      font-size: 12px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      cursor: pointer;
      background: rgba(248, 250, 252, 0.9);
      white-space: nowrap;
    }

    .session-item.active {
      background: var(--accent-soft);
      border-color: rgba(37, 99, 235, 0.4);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .session-title {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-meta {
      font-size: 10px;
      color: var(--muted);
    }

    /* Main Chat */
    .chat-shell {
      flex: 1;
      min-width: 0;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .chat-header {
      padding: 10px 16px;
      border-bottom: 1px solid rgba(226, 232, 240, 0.9);
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-title {
      font-size: 13px;
      font-weight: 600;
    }

    .chat-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .lang-toggle {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      background: #f1f5f9;
      padding: 3px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 11px;
    }

    .lang-btn {
      border-radius: 999px;
      padding: 4px 10px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 11px;
      color: var(--muted);
      min-width: 40px;
      text-align: center;
    }

    .lang-btn.active {
      background: white;
      color: var(--accent-strong);
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.16);
    }

    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: radial-gradient(circle at top, #e0f2fe 0, #ffffff 45%, #eef2ff 100%);
    }

    .suggestions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .suggestion-chip {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(248, 250, 252, 0.9);
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .suggestion-chip span.icon {
      font-size: 13px;
    }

    .msg-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .msg-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      max-width: 100%;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .avatar.bot {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .avatar.user {
      background: #0f172a;
      color: #e5e7eb;
    }

    .bubble {
      max-width: min(80%, 700px);
      border-radius: 14px;
      padding: 8px 10px;
      font-size: 13px;
      line-height: 1.5;
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-main);
      box-shadow: 0 5px 14px rgba(15, 23, 42, 0.05);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .msg-row.user .bubble {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #eff6ff;
      border-color: rgba(15, 23, 42, 0.15);
    }

    .bubble-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      font-size: 10px;
      color: var(--muted);
    }

    .badge {
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(248, 250, 252, 0.9);
      font-size: 10px;
      color: var(--muted);
    }

    .typing-dots {
      display: inline-flex;
      gap: 3px;
      align-items: center;
      justify-content: center;
    }

    .typing-dots span {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: #94a3b8;
      animation: blink 1.2s infinite ease-in-out;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.15s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes blink {
      0%, 80%, 100% {
        opacity: 0.3;
        transform: translateY(0);
      }
      40% {
        opacity: 1;
        transform: translateY(-2px);
      }
    }

    .chat-footer {
      border-top: 1px solid rgba(226, 232, 240, 0.9);
      padding: 8px 12px 10px;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .prompt-input-wrap {
      flex: 1;
      background: white;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 5px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .prompt-input {
      border: none;
      outline: none;
      background: transparent;
      flex: 1;
      font-size: 13px;
      resize: none;
      max-height: 80px;
      min-height: 22px;
    }

    .prompt-input::-webkit-scrollbar {
      width: 4px;
    }

    .prompt-input::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }

    .send-btn {
      border-radius: 999px;
      border: none;
      width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
      background: var(--accent);
      color: white;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.5);
    }

    .send-btn:disabled {
      opacity: 0.5;
      box-shadow: none;
      cursor: default;
    }

    .footer-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--muted);
    }

    @media (max-width: 600px) {
      .sidebar {
        padding: 10px;
      }
      .chat-header {
        padding-inline: 10px;
      }
      .chat-body {
        padding-inline: 10px;
      }
      .chat-footer {
        padding-inline: 10px;
      }
    }
  </style>
</head>
<body class="rtl">
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-mark">
          <div class="logo-badge">M</div>
          <div class="logo-text">
            <span class="logo-text-main" id="logoMain">Money AI</span>
            <span class="logo-text-sub" id="logoSub">Rush ‚Üí Rich Coach</span>
          </div>
        </div>
        <div class="pill" id="connPill">
          <span class="pill-dot"></span>
          <span id="connText">Connected (mock)</span>
        </div>
      </div>

      <button class="new-chat-btn" id="btnNewChat">
        <span class="icon">Ôºã</span>
        <span id="newChatLabel">New Money AI chat</span>
      </button>

      <ul class="session-list" id="sessionList">
        <!-- sessions injected here -->
      </ul>
    </aside>

    <!-- Chat -->
    <main class="chat-shell">
      <header class="chat-header">
        <div class="chat-header-left">
          <div>
            <div class="chat-title" id="chatTitle">Money AI ‚Äì Personal Coach</div>
            <div class="chat-subtitle" id="chatSubtitle">
              Ask about your money behavior, not just your balance.
            </div>
          </div>
        </div>
        <div class="chat-header-right">
          <div class="lang-toggle" id="langToggle">
            <button class="lang-btn active" data-lang="ar">AR</button>
            <button class="lang-btn" data-lang="en">EN</button>
          </div>
        </div>
      </header>

      <section class="chat-body">
        <div class="suggestions-row" id="suggestionsRow">
          <!-- suggestions injected -->
        </div>
        <div class="msg-list" id="msgList">
          <!-- messages injected -->
        </div>
      </section>

      <footer class="chat-footer">
        <div class="input-row">
          <div class="prompt-input-wrap">
            <textarea
              id="promptInput"
              class="prompt-input"
              rows="1"
              placeholder="ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ŸáŸÜÿß‚Ä¶"
            ></textarea>
          </div>
          <button class="send-btn" id="btnSend" disabled title="Send">
            ‚û§
          </button>
        </div>
        <div class="footer-meta">
          <span id="footerHint">Money AI ŸÑÿß Ÿäÿ∑ŸÑÿ® ÿ£ÿ±ŸÇÿßŸÖ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿ£Ÿà ŸÉŸÑŸÖÿßÿ™ ÿ≥ÿ±.</span>
          <span id="footerBrand">Powered by Money AI ¬∑ Local mock engine</span>
        </div>
      </footer>
    </main>
  </div>

  <script>
    // ==========================
    // i18n ‚Äì Arabic / English
    // ==========================
    const i18n = {
      ar: {
        logoMain: "Money AI",
        logoSub: "ŸÖŸÜ ÿπŸÇŸÑŸäÿ© Rush ÿ•ŸÑŸâ Rich",
        connText: "ŸÖÿ™ÿµŸÑ (ŸÖÿ≠ÿßŸÉÿßÿ© ŸÖÿ≠ŸÑŸäÿ© / MiniBank)",
        newChatLabel: "ÿ®ÿØÿ° ÿ¨ŸÑÿ≥ÿ© Money AI ÿ¨ÿØŸäÿØÿ©",
        chatTitle: "Money AI ‚Äì ŸÖÿØÿ±ÿ®ŸÉ ÿßŸÑŸÖÿßŸÑŸä",
        chatSubtitle: "ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿ≥ŸÑŸàŸÉŸÉ ÿßŸÑŸÖÿßŸÑŸä ŸàŸÑŸäÿ≥ ÿπŸÜ ÿßŸÑÿ±ÿµŸäÿØ ŸÅŸÇÿ∑.",
        placeholder: "ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ŸáŸÜÿß‚Ä¶",
        footerHint: "Money AI ŸÑŸÜ Ÿäÿ∑ŸÑÿ® ŸÖŸÜŸÉ ÿ£ÿ®ÿØŸãÿß ÿ£ÿ±ŸÇÿßŸÖ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿ£Ÿà ŸÉŸÑŸÖÿßÿ™ ÿ≥ÿ±.",
        footerBrand: "ŸÖÿØÿπŸàŸÖ ŸÖŸÜ Money AI ¬∑ ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ±ÿ®ÿ∑ ŸÖÿπ MiniBank",
        suggestion1: "ŸÇŸäŸëŸÖ Ÿàÿ∂ÿπŸä ÿßŸÑŸÖÿßŸÑŸä ÿßŸÑÿ¢ŸÜ",
        suggestion2: "ŸÖÿß ÿßŸÑŸÅÿ±ŸÇ ÿ®ŸäŸÜ ÿπŸÇŸÑŸäÿ™Ÿä ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸàÿπŸÇŸÑŸäÿ© ÿßŸÑÿ∫ŸÜŸäÿü",
        suggestion3: "ÿ≥ÿßÿπÿØŸÜŸä ÿ£ÿ∂ÿπ ÿÆÿ∑ÿ© ŸÑŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ´ŸÑÿßÿ´ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©",
        suggestion4: "ŸÉŸäŸÅ ÿ£ÿ≥ÿ™ÿÆÿØŸÖ MiniBank + Money AI ŸÖÿπŸãÿßÿü",
        sysWelcome:
          "ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ ŸÅŸä Money AI üëã\n" +
          "ÿ£ŸÜÿß ŸÑÿ≥ÿ™ ŸÖÿ¨ÿ±ÿØ ÿ¥ÿßÿ™ ÿ®Ÿàÿ™ÿå ÿ£ŸÜÿß ŸÖÿØÿ±ÿ® ŸÖÿßŸÑŸä Ÿäÿ±ŸÉŸëÿ≤ ÿπŸÑŸâ ÿ™ÿ≠ŸàŸäŸÑ ÿ≥ŸÑŸàŸÉŸÉ ŸÖŸÜ Rush ÿ•ŸÑŸâ Rich.\n" +
          "ÿßÿ≥ÿ£ŸÑŸÜŸä ŸÖÿ´ŸÑÿßŸã:\n" +
          "‚Ä¢ ŸÉŸäŸÅ ÿ£ÿÆÿ±ÿ¨ ŸÖŸÜ ÿßŸÑÿØŸäŸàŸÜ ÿ®ÿÆÿ∑ÿ© ŸàÿßŸÇÿπŸäÿ©ÿü\n" +
          "‚Ä¢ ŸÉŸäŸÅ ÿ£ÿ≥ÿ™ÿÆÿØŸÖ MiniBank ŸÑŸÖÿ≠ÿßŸÉÿßÿ© ŸÇÿ±ÿßÿ±ÿßÿ™Ÿäÿü\n" +
          "‚Ä¢ ŸÖÿß ŸáŸä ÿ£ŸÉÿ®ÿ± ÿ£ÿÆÿ∑ÿßÿ° ÿßŸÑÿµÿ±ŸÅ ÿßŸÑÿ™Ÿä ÿ™ŸÇÿπ ŸÅŸäŸáÿß ŸÅÿ¶ÿ© ÿßŸÑŸÄ Rushÿü",
        sysUsingInsights:
          "ÿ™ŸÖ ÿ™ÿ¨ŸáŸäÿ≤ Ÿáÿ∞Ÿá ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ŸÑŸÑÿßÿ™ÿµÿßŸÑ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ®ŸÄ Money AI Insights ÿØÿßÿÆŸÑ MiniBank.\n" +
          "ŸÑŸà ŸÉÿßŸÜ ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖŸÅÿ™Ÿàÿ≠ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑÿµŸÅÿ≠ÿ© Ÿàÿ≥Ÿäÿ™ŸÖ ÿ™ŸàŸÅŸäÿ± snapshotÿå ÿ≥ÿ™ÿµÿ®ÿ≠ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿ¥ÿÆÿµŸäÿ© ŸÖÿ®ŸÜŸäÿ© ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ©.",
        userLabel: "ÿ£ŸÜÿ™",
        botLabel: "Money AI",
        timeNow: "ÿßŸÑÿ¢ŸÜ",
        mockReplyGeneric: (prompt) =>
          "ŸÅŸáŸÖÿ™ ÿ≥ÿ§ÿßŸÑŸÉ üëå\n" +
          "ŸÉŸÖÿ≠ÿ±ŸÉ Money AI ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä (ÿ£Ÿà ŸÅŸä ÿ≠ÿßŸÑ ÿπÿØŸÖ ÿ™ŸàŸÅÿ± ÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ MiniBank ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÑÿ≠ÿ∏ÿ©)ÿå " +
          "ÿ≥ÿ£ÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿ≥ÿ§ÿßŸÑŸÉ ŸÖŸÜ ÿ≤ÿßŸàŸäÿ© ÿßŸÑÿ≥ŸÑŸàŸÉ ÿßŸÑŸÖÿßŸÑŸä ŸàŸÑŸäÿ≥ ŸÖÿ¨ÿ±ÿØ ÿ£ÿ±ŸÇÿßŸÖ.\n\n" +
          "Ÿ°) ÿ£Ÿàÿ∂ÿ≠ ŸÑŸä ÿßŸÑŸáÿØŸÅ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑÿ∞Ÿä ÿ™ÿ±ŸäÿØ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸá (ÿ≠ÿ±Ÿäÿ© ŸÖŸÜ ÿØŸäŸàŸÜÿü ÿßÿØÿÆÿßÿ±ÿü ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±ÿü).\n" +
          "Ÿ¢) ŸÇÿ≥ŸëŸÖ ÿØÿÆŸÑŸÉ ÿßŸÑÿ≠ÿßŸÑŸä ÿ•ŸÑŸâ Ÿ£ ÿµŸÜÿßÿØŸäŸÇ: ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ¨ÿßÿ™ÿå ÿßŸÑÿ£ŸÖÿßŸÜÿå ÿßŸÑŸÜŸÖŸà.\n" +
          "Ÿ£) ŸÉŸÑ ŸÇÿ±ÿßÿ± ¬´Rush¬ª ŸáŸà ŸÇÿ±ÿßÿ± Ÿäÿπÿ∑ŸäŸÉ ÿ¥ÿπŸàÿ± ŸÅŸàÿ±Ÿä ŸàŸäÿ£ÿÆÿ∞ ŸÖŸÜŸÉ ŸàŸÇÿ™ ÿ£Ÿà ŸÖÿßŸÑ ÿ∑ŸàŸäŸÑ.\n\n" +
          "ŸÑŸà ÿ±ÿ®ÿ∑ŸÜÿß Ÿáÿ∞Ÿá ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ŸÅÿπŸÑŸäŸãÿß ÿ®ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÅŸä MiniBankÿå Money AI ÿ≥ŸäŸÇÿ±ÿ£:\n" +
          "‚Ä¢ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿµÿ±ŸÅ ÿßŸÑŸäŸàŸÖŸä\n" +
          "‚Ä¢ Runway (ŸÉŸÖ ŸäŸàŸÖ ÿ™ŸÉŸÖŸÑ ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸÜŸÖÿ∑)\n" +
          "‚Ä¢ ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ≠ÿ±ŸÇŸÉ (ÿ™ÿ±ŸÅŸäŸáÿå ÿ£ŸÉŸÑ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿ®Ÿäÿ™ÿå ÿ•ŸÑÿÆ)\n" +
          "ÿ´ŸÖ Ÿäÿ∂ÿπ ÿÆÿ∑ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ŸÖÿÆÿµÿµÿ© ŸÑŸÉ.",
        mockReplyHint:
          "‚ö†Ô∏è ÿ™ÿ∞ŸÉŸäÿ±: ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ MiniBank ŸÖŸàÿµŸàŸÑ ÿ≠ÿßŸÑŸäŸãÿßÿå Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿàÿ∂ÿπ ÿßŸÑÿØŸäŸÖŸà ÿ®ÿØŸàŸÜ ŸÑŸÖÿ≥ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ."
      },
      en: {
        logoMain: "Money AI",
        logoSub: "Rush ‚Üí Rich Mindset",
        connText: "Connected (local mock / MiniBank)",
        newChatLabel: "New Money AI chat",
        chatTitle: "Money AI ‚Äì Your Money Coach",
        chatSubtitle: "Ask about your behavior, not just your balance.",
        placeholder: "Type your question here‚Ä¶",
        footerHint: "Money AI will never ask for card numbers or passwords.",
        footerBrand: "Powered by Money AI ¬∑ Ready to plug into MiniBank",
        suggestion1: "Assess my money situation now",
        suggestion2: "What is the gap between my mindset and a rich one?",
        suggestion3: "Help me design a 3-month plan",
        suggestion4: "How do I use MiniBank + Money AI together?",
        sysWelcome:
          "Welcome to Money AI üëã\n" +
          "I‚Äôm not just a chatbot ‚Äì I‚Äôm a money coach that helps you shift from Rush to Rich behavior.\n" +
          "You can ask things like:\n" +
          "‚Ä¢ How do I escape debt with a realistic plan?\n" +
          "‚Ä¢ How should I use MiniBank to simulate decisions?\n" +
          "‚Ä¢ What are the most common Rush mistakes people do?",
        sysUsingInsights:
          "This chat is prepared to plug directly into Money AI Insights inside MiniBank.\n" +
          "If a snapshot is exposed on this page, answers become personalized to your real data.",
        userLabel: "You",
        botLabel: "Money AI",
        timeNow: "now",
        mockReplyGeneric: (prompt) =>
          "Got it üëå\n" +
          "As a demo Money AI engine (or when MiniBank data is not available yet), " +
          "I will answer from a behavior-first perspective instead of raw numbers.\n\n" +
          "1) Clarify the end state you want (debt-free, savings, investments).\n" +
          "2) Split your income into 3 buckets: Needs, Safety, Growth.\n" +
          "3) Every ‚ÄúRush‚Äù decision gives you instant feeling but steals time/wealth later.\n\n" +
          "If this chat were fully connected to your MiniBank:\n" +
          "‚Ä¢ I would read your average daily spend\n" +
          "‚Ä¢ Your runway (how many days you can survive)\n" +
          "‚Ä¢ The categories that burn you (entertainment, eating out, etc.)\n" +
          "Then I would build a weekly action plan tailored to you.",
        mockReplyHint:
          "‚ö†Ô∏è Reminder: if MiniBank is not wired into this page, demo mode is used and your actual data is not touched."
      }
    };

    let currentLang = "ar";

    // ==========================
    // State
    // ==========================
    const state = {
      sessions: [],
      activeSessionId: null,
      sending: false
    };

    function createSessionTitle() {
      const d = new Date();
      return currentLang === "ar"
        ? `ÿ¨ŸÑÿ≥ÿ© ${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`
        : `Session ${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`;
    }

    function newSession() {
      const id = "s_" + Date.now() + "_" + Math.random().toString(36).slice(2);
      const session = {
        id,
        title: createSessionTitle(),
        createdAt: Date.now(),
        messages: []
      };
      state.sessions.unshift(session);
      state.activeSessionId = id;
      renderSessions();
      renderMessages();
      injectWelcomeIfEmpty();
    }

    function getActiveSession() {
      return state.sessions.find((s) => s.id === state.activeSessionId) || null;
    }

    // ==========================
    // DOM Helpers
    // ==========================
    const $ = (sel) => document.querySelector(sel);

    const msgListEl = $("#msgList");
    const sessionListEl = $("#sessionList");
    const promptInputEl = $("#promptInput");
    const btnSendEl = $("#btnSend");
    const suggestionsRowEl = $("#suggestionsRow");
    const connTextEl = $("#connText");

    function setLang(lang) {
      if (!i18n[lang]) return;
      currentLang = lang;

      // dir
      if (lang === "ar") {
        document.body.classList.add("rtl");
        document.body.classList.remove("ltr");
        document.documentElement.setAttribute("dir", "rtl");
        document.documentElement.setAttribute("lang", "ar");
      } else {
        document.body.classList.add("ltr");
        document.body.classList.remove("rtl");
        document.documentElement.setAttribute("dir", "ltr");
        document.documentElement.setAttribute("lang", "en");
      }

      // header / chrome text
      $("#logoMain").textContent = i18n[lang].logoMain;
      $("#logoSub").textContent = i18n[lang].logoSub;
      $("#connText").textContent = i18n[lang].connText;
      $("#newChatLabel").textContent = i18n[lang].newChatLabel;
      $("#chatTitle").textContent = i18n[lang].chatTitle;
      $("#chatSubtitle").textContent = i18n[lang].chatSubtitle;
      promptInputEl.placeholder = i18n[lang].placeholder;
      $("#footerHint").textContent = i18n[lang].footerHint;
      $("#footerBrand").textContent = i18n[lang].footerBrand;

      // suggestions
      renderSuggestions();

      // update lang buttons
      document
        .querySelectorAll(".lang-btn")
        .forEach((btn) =>
          btn.classList.toggle("active", btn.dataset.lang === lang)
        );

      // re-render sessions titles
      renderSessions();

      // ensure a session exists
      if (!getActiveSession()) {
        newSession();
      } else {
        renderMessages();
      }
    }

    function renderSuggestions() {
      const dict = i18n[currentLang];
      const items = [
        { key: "suggestion1", icon: "‚ö°" },
        { key: "suggestion2", icon: "üß†" },
        { key: "suggestion3", icon: "üìÖ" },
        { key: "suggestion4", icon: "üîó" }
      ];

      suggestionsRowEl.innerHTML = "";
      items.forEach((it) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "suggestion-chip";
        chip.innerHTML = `<span class="icon">${it.icon}</span><span>${dict[it.key]}</span>`;
        chip.addEventListener("click", () => {
          promptInputEl.value = dict[it.key];
          promptInputEl.focus();
          updateSendButtonState();
        });
        suggestionsRowEl.appendChild(chip);
      });
    }

    function renderSessions() {
      sessionListEl.innerHTML = "";
      if (!state.sessions.length) return;
      state.sessions.forEach((s) => {
        const li = document.createElement("li");
        li.className =
          "session-item" + (s.id === state.activeSessionId ? " active" : "");
        const title = document.createElement("span");
        title.className = "session-title";
        title.textContent = s.title;
        const meta = document.createElement("span");
        meta.className = "session-meta";
        const count = s.messages.length;
        meta.textContent =
          count > 0
            ? currentLang === "ar"
              ? `${count} ÿ±ÿ≥ÿßŸÑÿ©`
              : `${count} msg`
            : "";
        li.appendChild(title);
        li.appendChild(meta);
        li.addEventListener("click", () => {
          state.activeSessionId = s.id;
          renderSessions();
          renderMessages();
        });
        sessionListEl.appendChild(li);
      });
    }

    function injectWelcomeIfEmpty() {
      const s = getActiveSession();
      if (!s) return;
      if (s.messages.length) return;

      const dict = i18n[currentLang];
      s.messages.push({
        id: "m_" + Date.now(),
        role: "assistant",
        content: dict.sysWelcome + "\n\n" + dict.sysUsingInsights,
        ts: Date.now()
      });
      renderMessages();
    }

    function renderMessages() {
      const s = getActiveSession();
      msgListEl.innerHTML = "";
      if (!s) return;

      s.messages.forEach((m) => {
        const row = document.createElement("div");
        row.className = "msg-row " + (m.role === "user" ? "user" : "bot");

        const avatar = document.createElement("div");
        avatar.className =
          "avatar " + (m.role === "user" ? "user" : "bot");
        avatar.textContent =
          m.role === "user"
            ? (currentLang === "ar" ? "ÿ£" : "U")
            : "M";

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = m.content;

        const meta = document.createElement("div");
        meta.className = "bubble-meta";

        const who = document.createElement("span");
        who.textContent =
          m.role === "user"
            ? i18n[currentLang].userLabel
            : i18n[currentLang].botLabel;

        const time = document.createElement("span");
        time.textContent = i18n[currentLang].timeNow;

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent =
          m.role === "user" ? "Prompt" : "Money AI";

        meta.appendChild(who);
        meta.appendChild(badge);
        meta.appendChild(time);

        bubble.appendChild(meta);

        if (m.role === "user") {
          row.appendChild(bubble);
          row.appendChild(avatar);
        } else {
          row.appendChild(avatar);
          row.appendChild(bubble);
        }
        msgListEl.appendChild(row);
      });

      msgListEl.scrollTop = msgListEl.scrollHeight;
    }

    function appendUserMessage(text) {
      const s = getActiveSession();
      if (!s) return;
      s.messages.push({
        id: "m_" + Date.now(),
        role: "user",
        content: text,
        ts: Date.now()
      });
      renderMessages();
    }

    function appendBotTyping() {
      const row = document.createElement("div");
      row.className = "msg-row bot";

      const avatar = document.createElement("div");
      avatar.className = "avatar bot";
      avatar.textContent = "M";

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const dots = document.createElement("div");
      dots.className = "typing-dots";
      dots.innerHTML = "<span></span><span></span><span></span>";

      const meta = document.createElement("div");
      meta.className = "bubble-meta";
      const who = document.createElement("span");
      who.textContent = i18n[currentLang].botLabel;
      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = "typing‚Ä¶";
      meta.appendChild(who);
      meta.appendChild(badge);

      bubble.appendChild(dots);
      bubble.appendChild(meta);

      row.appendChild(avatar);
      row.appendChild(bubble);
      msgListEl.appendChild(row);
      msgListEl.scrollTop = msgListEl.scrollHeight;

      return row;
    }

    function replaceTypingWithBotMessage(row, text) {
      const s = getActiveSession();
      if (!s) return;
      s.messages.push({
        id: "m_" + Date.now(),
        role: "assistant",
        content: text,
        ts: Date.now()
      });
      renderMessages();
    }

    // ==========================
    // MiniBank / Money AI integration
    // ==========================
    // ==========================
    // MiniBank / Money AI integration (window / opener / parent)
    // ==========================
    function getRootCtx() {
      const seen = new Set();
      const chain = [window, window.opener, window.parent];
      for (const ctx of chain) {
        if (!ctx || seen.has(ctx)) continue;
        seen.add(ctx);
        if (ctx.MoneyAIInsights || ctx.getMoneyAISnapshotForReport) {
          return ctx;
        }
      }
      return window;
    }

    function getExternalSnapshot() {
      try {
        const ctx = getRootCtx();

        // 1) Preferred: MoneyAIInsights
        if (
          ctx.MoneyAIInsights &&
          typeof ctx.MoneyAIInsights.getSnapshot === "function"
        ) {
          const snap = ctx.MoneyAIInsights.getSnapshot();
          return snap || null;
        }

        // 2) Legacy helper
        if (typeof ctx.getMoneyAISnapshotForReport === "function") {
          const snap = ctx.getMoneyAISnapshotForReport();
          return snap || null;
        }

        return null;
      } catch (e) {
        console.warn("MoneyAI snapshot error:", e);
        return null;
      }
    }

    function getExternalPersonalizedAdvice(prompt, snapshot) {
      try {
        const ctx = getRootCtx();
        if (
          ctx.MoneyAIInsights &&
          typeof ctx.MoneyAIInsights.getPersonalizedAdvice === "function"
        ) {
          const res = ctx.MoneyAIInsights.getPersonalizedAdvice({
            prompt,
            lang: currentLang,
            snapshot
          });
          if (typeof res === "string" && res.trim()) return res;
        }
      } catch (e) {
        console.warn("MoneyAI personalizedAdvice error:", e);
      }
      return null;
    }

    function formatPersonalizedReply(prompt, snapshot) {
      const dict = i18n[currentLang];
      if (!snapshot) return dict.mockReplyGeneric(prompt) + "\n\n" + dict.mockReplyHint;

      const {
        behaviorStyle,
        behaviorLabel,
        weekType,
        weekSummary,
        runwayDays,
        net30,
        totalOut30,
        totalIncome30,
        score,
        scoreLabel,
        currentBalance,
        displayCur,
        dailySpend,
        dailySpend7,
        categoriesDisplay = [],
        goals = []
      } = snapshot;

      const label = displayCur || (currentLang === "ar" ? "ÿ±.ŸÇ" : "QAR");
      const fmt = (n) => Number(n || 0).toFixed(2);
      const fmtInt = (n) => Math.round(n || 0);

      const lines = [];
      if (currentLang === "ar") {
        lines.push("Ÿáÿ∞ÿß ÿ±ÿØ ÿ¥ÿÆÿµŸä ŸÖÿ®ŸÜŸä ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ MiniBank ÿßŸÑÿ≠ÿßŸÑŸäÿ©:");
        lines.push("");
        lines.push(`‚Ä¢ ÿßŸÑÿ≥ŸÑŸàŸÉ ÿßŸÑÿπÿßŸÖ: ${behaviorStyle} (${behaviorLabel})`);
        lines.push(`‚Ä¢ ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ: ${weekType}`);
        lines.push(`‚Ä¢ ÿµÿßŸÅŸä ÿ¢ÿÆÿ± 30 ŸäŸàŸÖ: ${fmt(net30)} ${label}`);
        lines.push(`‚Ä¢ ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅ: ${fmt(totalOut30)} ${label}`);
        lines.push(`‚Ä¢ ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿØÿÆŸÑ: ${fmt(totalIncome30)} ${label}`);
        lines.push(`‚Ä¢ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿµÿ±ŸÅ ÿßŸÑŸäŸàŸÖŸä: ${fmt(dailySpend)} ${label}`);
        lines.push(`‚Ä¢ Runway ÿ™ŸÇÿ±Ÿäÿ®Ÿä: ${fmtInt(runwayDays)} ŸäŸàŸÖ`);
        lines.push(`‚Ä¢ Rush ‚Üí Rich Score: ${fmtInt(score)} / 100 (${scoreLabel})`);
        if (categoriesDisplay && categoriesDisplay.length) {
          lines.push("");
          lines.push("ÿ£ŸÉÿ´ÿ± ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ŸÖŸäÿ≤ÿßŸÜŸäÿ™ŸÉ ÿßŸÑÿ¢ŸÜ:");
          categoriesDisplay.slice(0, 3).forEach((c, idx) => {
            lines.push(
              `  ${idx + 1}) ${c.label}: ${fmt(c.total)} ${label} (${fmtInt(c.share || 0)}Ÿ™ ŸÖŸÜ ÿßŸÑŸÖÿµÿ±ŸàŸÅ)`
            );
          });
        }
        if (goals && goals.length) {
          const activeGoals = goals.filter((g) => !g.done);
          if (activeGoals.length) {
            lines.push("");
            lines.push("ÿ£ŸáÿØÿßŸÅŸÉ ÿßŸÑŸÜÿ¥ÿ∑ÿ©:");
            activeGoals.slice(0, 3).forEach((g) => {
              lines.push(
                `  ‚Ä¢ ${g.title || "ŸáÿØŸÅ"} ‚Äì ÿßŸÑŸáÿØŸÅ ${fmt(g.target || 0)} ${label}`
              );
            });
          }
        }
        lines.push("");
        lines.push("ÿßŸÉÿ™ÿ® ŸÑŸä ŸÖÿ´ŸÑÿßŸã: \"ŸÉŸäŸÅ ÿ£ÿ≠ÿ≥ŸÜ ÿßŸÑ scoreÿü\" ÿ£Ÿà \"ŸÉŸäŸÅ ÿ£ÿ±ŸÅÿπ ÿßŸÑŸÄ runwayÿü\" ŸÑÿ£ÿπÿ∑ŸäŸÉ ÿÆÿ∑ÿ© ÿ£ÿØŸÇ.");
      } else {
        lines.push("This is a personalized reply based on your MiniBank snapshot:");
        lines.push("");
        lines.push(`‚Ä¢ Behavior: ${behaviorStyle} (${behaviorLabel})`);
        lines.push(`‚Ä¢ Week type: ${weekType}`);
        lines.push(`‚Ä¢ Net last 30 days: ${fmt(net30)} ${label}`);
        lines.push(`‚Ä¢ Total spending: ${fmt(totalOut30)} ${label}`);
        lines.push(`‚Ä¢ Total income: ${fmt(totalIncome30)} ${label}`);
        lines.push(`‚Ä¢ Avg daily spend: ${fmt(dailySpend)} ${label}`);
        lines.push(`‚Ä¢ Estimated runway: ${fmtInt(runwayDays)} days`);
        lines.push(`‚Ä¢ Rush ‚Üí Rich Score: ${fmtInt(score)} / 100 (${scoreLabel})`);
        if (categoriesDisplay && categoriesDisplay.length) {
          lines.push("");
          lines.push("Top pressure categories now:");
          categoriesDisplay.slice(0, 3).forEach((c, idx) => {
            lines.push(
              `  ${idx + 1}) ${c.label}: ${fmt(c.total)} ${label} (${fmtInt(c.share || 0)}% of spending)`
            );
          });
        }
        if (goals && goals.length) {
          const activeGoals = goals.filter((g) => !g.done);
          if (activeGoals.length) {
            lines.push("");
            lines.push("Active goals:");
            activeGoals.slice(0, 3).forEach((g) => {
              lines.push(
                `  ‚Ä¢ ${g.title || "Goal"} ‚Äì target ${fmt(g.target || 0)} ${label}`
              );
            });
          }
        }
        lines.push("");
        lines.push(
          'You can now ask things like "How do I improve my score?" or "How do I extend my runway?" for a sharper plan.'
        );
      }

      return lines.join("\n");
    }


    // ==========================
    // Mock / integrated reply
    // ==========================
function generateBotReply(prompt) {
  // ŸÑŸà ÿ≠ÿµŸÑ ÿ£Ÿä ÿÆŸÑŸÑ ŸÅŸä i18n ŸÜÿ±ÿ¨ÿπ ŸÑŸÑÿπÿ±ÿ®Ÿä ŸÉŸÄ default
  const dict = i18n[currentLang] || i18n.ar;

  try {
    // ŸÜÿ≠ÿßŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÜŸÇÿ±ÿ£ snapshot ŸÖŸÜ MiniBank (ŸÑŸà ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖŸÅÿ™Ÿàÿ≠ÿ©)
    const snapshot = getExternalSnapshot();

    // ŸÑŸà MoneyAIInsights ŸÅŸä MiniBank ÿ£ÿπÿ∑ÿßŸÜÿß ŸÜÿµ ÿ¨ÿßŸáÿ≤ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖŸá
    const externalText = getExternalPersonalizedAdvice(prompt, snapshot);
    if (typeof externalText === "string" && externalText.trim()) {
      return externalText;
    }

    // ŸÑŸà ŸÅŸä snapshot ÿ®ÿ≥ ŸÖÿß ŸÅŸä externalTextÿå ŸÜÿ®ŸÜŸä ÿ±ÿØ ÿ¥ÿÆÿµŸä ŸÖŸÜ snapshot
    if (snapshot) {
      const personalized = formatPersonalizedReply(prompt, snapshot);
      if (typeof personalized === "string" && personalized.trim()) {
        return personalized;
      }
    }
  } catch (err) {
    console.warn("Money AI chat: falling back to mock reply due to error:", err);
    // ÿ£Ÿä ÿÆÿ∑ÿ£ ŸáŸÜÿß ŸÖÿß ÿ±ÿßÿ≠ ŸäŸàŸÇŸÅ ÿßŸÑŸÄ typingÿå ÿ®ÿ≥ Ÿäÿ∑Ÿäÿ≠ŸÜÿß ÿπŸÑŸâ ÿßŸÑÿ±ÿØ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿä
  }

  // fallback ÿßŸÑÿ¢ŸÖŸÜ ÿØÿßÿ¶ŸÖŸãÿß ‚Äì ŸÖÿ≠ÿ±ŸÉ demo ÿ®ÿØŸàŸÜ MiniBank
  let body = dict.mockReplyGeneric(prompt);
  body += "\n\n" + dict.mockReplyHint;
  return body;
}

    function sendPrompt() {
      const text = (promptInputEl.value || "").trim();
      if (!text || state.sending) return;
      state.sending = true;
      updateSendButtonState();

      appendUserMessage(text);
      promptInputEl.value = "";
      updateSendButtonState();

      const typingRow = appendBotTyping();

      setTimeout(() => {
        const reply = generateBotReply(text);
        replaceTypingWithBotMessage(typingRow, reply);
        state.sending = false;
        updateSendButtonState();
      }, 900 + Math.random() * 700);
    }

    function updateSendButtonState() {
      const text = (promptInputEl.value || "").trim();
      btnSendEl.disabled = !text || state.sending;
    }

    // ==========================
    // Events
    // ==========================
    btnSendEl.addEventListener("click", sendPrompt);
    promptInputEl.addEventListener("input", updateSendButtonState);
    promptInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendPrompt();
      }
    });

    $("#btnNewChat").addEventListener("click", () => {
      newSession();
      injectWelcomeIfEmpty();
    });

    document.querySelectorAll(".lang-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const lang = btn.dataset.lang;
        setLang(lang);
      });
    });

    // ==========================
    // Init
    // ==========================
    (function init() {
      // start in Arabic
      setLang("ar");
      // create initial session
      newSession();
      injectWelcomeIfEmpty();

      // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÑŸà snapshot ŸÖÿ™ŸàŸÅÿ±
      const snap = getExternalSnapshot();
      if (snap && connTextEl) {
        connTextEl.textContent =
          currentLang === "ar"
            ? "ŸÖÿ™ÿµŸÑ ÿ®ŸÄ MiniBank (snapshot ŸÜÿ¥ÿ∑)"
            : "Connected to MiniBank (live snapshot)";
      }
    })();
  </script>
</body>
</html>
